rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdminEmail() {
      // Hardcoded Admin Whitelist - Server Side Source of Truth
      return request.auth.token.email in ['admin@dnadestek.com', 'eren.gulmez@dnadestek.com'];
    }

    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rol == 'yonetim';
    }
    
    function isTechnician() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rol == 'teknisyen';
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Users Collection
    match /users/{userId} {
      // Read: Owner can see own profile. Admin/Tech can see specific profiles.
      allow get: if isSignedIn() && (isOwner(userId) || isAdmin() || isTechnician());
      // List: Only Admins can list all users (Technicians restricted for privacy)
      allow list: if isAdmin();
      
      // Create: Owner can create own profile.
      // Must validate Role: 
      // - Standard users can ONLY set 'musteri'.
      // - Whitelisted emails can set 'yonetim'.
      // - Nobody can self-assign 'teknisyen'.
      allow create: if isSignedIn() && isOwner(userId) && (
        request.resource.data.rol == 'musteri' || 
        (request.resource.data.rol == 'yonetim' && isAdminEmail())
      );
      
      // Update: Admin can update anyone. Owner can update self.
      // - If Owner updates, they CANNOT escalate privileges or change 'aktif' status.
      allow update: if isAdmin() || (isOwner(userId) && (
        (request.resource.data.rol == resource.data.rol && request.resource.data.aktif == resource.data.aktif) // Role and Active status must not change for owner update
      ));
      
      // Admin creation via Management screen
      allow create: if isAdmin() || (isSignedIn() && isOwner(userId) && request.resource.data.rol == 'musteri');
    }

    // Talepler Collection
    match /talepler/{talepId} {
      // Read: Admins see all. Technicians see ONLY assigned tickets. Customers see their own.
      allow read: if isSignedIn() && (
        isAdmin() || 
        (isTechnician() && (
          resource.data.atananTeknisyenId == request.auth.uid || 
          resource.data.atananEkipId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.kategori
        )) ||
        resource.data.olusturanId == request.auth.uid ||
        resource.data.musteriId == request.auth.uid
      );
      allow create: if isSignedIn() && 
        request.resource.data.olusturanId == request.auth.uid && 
        request.resource.data.durum == 'yeni' &&
        request.resource.data.oncelik in ['normal', 'acil'];
      allow update: if isSignedIn() && (
        isAdmin() || 
        // Technician: Can update status, solution, and comments on assigned tickets
        (isTechnician() && (
          (resource.data.atananTeknisyenId == request.auth.uid || 
           resource.data.atananEkipId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.kategori) &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['durum', 'cozumTarihi', 'cozumFotograflari', 'guncellemeTarihi', 'yorumlar'])
        )) ||
        // Customer: Can edit own ticket if 'yeni', or rate if 'cozuldu'
        (resource.data.olusturanId == request.auth.uid && (
          // Edit only when status is 'yeni'
          (resource.data.durum == 'yeni' && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['baslik', 'aciklama', 'fotograflar', 'guncellemeTarihi'])) ||
          // Cancel only when status is 'yeni'
          (resource.data.durum == 'yeni' && request.resource.data.durum == 'iptal' && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['durum', 'guncellemeTarihi'])) ||
          // Rate only when status is 'cozuldu'
          (resource.data.durum == 'cozuldu' && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['puan', 'degerlendirme', 'degerlendirmeTarihi']))
        ))
      );
    }

    // Ekipler Collection - Admin only for CRUD
    match /ekipler/{ekipId} {
      allow read: if isSignedIn() && (isAdmin() || isTechnician());
      allow create: if isAdmin() || isAdminEmail();
      allow update: if isAdmin() || isAdminEmail();
      allow delete: if isAdmin() || isAdminEmail();
    }

    // Projeler Collection - Admin can manage, all authenticated can read
    match /projeler/{projeId} {
      allow read: if isSignedIn();
      allow write: if isAdmin() || isAdminEmail();
    }

    // Push Tokens Collection
    match /push_tokens/{userId} {
      allow read: if isAdmin() || isTechnician();
      allow get, write: if isSignedIn() && isOwner(userId);
    }
  }
}

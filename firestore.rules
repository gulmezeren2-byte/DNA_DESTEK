rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Yardımcı Fonksiyonlar
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdminEmail() {
      // Sunucu taraflı Admin Beyaz Listesi (Source of Truth)
      // SEC-012: Safe access with .get() and case-insensitivity
      return isSignedIn() && 
             request.auth.token.get('email', '').lower() in ['admin@dnadestek.com', 'eren.gulmez@dnadestek.com'];
    }

    function isAdmin() {
      // SEC-002 FIX: Admin whitelist bypass for profile-less state (Recovery)
      // SEC-005/012: Check doc existence before field access to prevent rule crash
      return isSignedIn() && (
        isAdminEmail() || 
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rol in ['yonetim', 'yonetim_kurulu'])
      );
    }
    
    function isManager() {
      // Sadece 'yonetim' rolü (Yönetim Kurulu HARİÇ)
      return isSignedIn() && (
        isAdminEmail() || 
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rol == 'yonetim')
      );
    }
    
    function isTechnician() {
      // SEC-012: Robust existence check
      return isSignedIn() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rol == 'teknisyen';
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // =====================
    // KULLANICILAR (users)
    // =====================
    match /users/{userId} {
      // Okuma: Kendi profilini herkes, Admin/Teknisyen belirli profilleri görebilir.
      // SEC-012: Prioritize isOwner check for performance and reliability
      allow get: if isSignedIn() && (isOwner(userId) || isAdmin() || isTechnician());
      
      // Listeleme: Sadece yöneticiler (gizlilik gereği teknisyenler listeleyemez).
      allow list: if isAdmin();
      
      // Oluşturma (TEK KURAL - Konsolide):
      // - Admin herhangi bir kullanıcı oluşturabilir (Yönetim paneli).
      // - Kullanıcı kendi profilini oluşturabilir: sadece 'musteri' veya whitelist'teyse 'yonetim'.
      allow create: if isAdmin() || (
        isSignedIn() && isOwner(userId) && (
          request.resource.data.rol == 'musteri' || 
          (request.resource.data.rol == 'yonetim' && isAdminEmail())
        )
      );
      
      // Güncelleme: Admin herkesin bilgisini güncelleyebilir. 
      // Kullanıcı kendi bilgilerini güncelleyebilir (rol/aktiflik değiştiremez).
      allow update: if isAdmin() || (isOwner(userId) && (
        request.resource.data.rol == resource.data.rol && 
        request.resource.data.aktif == resource.data.aktif
      ));

      // Silme: Sadece 'yonetim' rolü silebilir (Yönetim Kurulu SİLEMEZ).
      allow delete: if isManager();
    }

    // =====================
    // TALEPLER (talepler)
    // =====================
    match /talepler/{talepId} {
      // Okuma: Yönetici her şeyi, Teknisyen sadece atanmış işleri, Müşteri kendi işini görür.
      allow read: if isSignedIn() && (
        isAdmin() || 
        (isTechnician() && (
          resource.data.atananTeknisyenId == request.auth.uid || 
          resource.data.atananEkipId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.kategori ||
          // FLOW-001: Teknisyenler kendi kategorilerindeki 'yeni' (atanmamış) talepleri görebilir
          (resource.data.durum == 'yeni' && resource.data.kategori == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.kategori) ||
          // TEAM-002: Teknisyen ekibin uyesi ise gorebilir (Robust Team Query)
          (resource.data.atananEkipUyeIds != null && request.auth.uid in resource.data.atananEkipUyeIds)
        )) ||
        resource.data.olusturanId == request.auth.uid ||
        resource.data.musteriId == request.auth.uid
      );

      // Oluşturma: Sadece yeni durumda ve normal/acil öncelikle başlanabilir.
      allow create: if isSignedIn() && 
        request.resource.data.olusturanId == request.auth.uid && 
        request.resource.data.durum == 'yeni' &&
        request.resource.data.oncelik in ['normal', 'acil'] &&
        // VAL-001: Veri doğrulama
        request.resource.data.baslik.size() <= 100 &&
        request.resource.data.aciklama.size() <= 1000;

      // Güncelleme:
      allow update: if isSignedIn() && (
        isAdmin() || 
        // Teknisyen: Sadece atanmış işlerin durumunu, çözümünü ve yorumlarını güncelleyebilir.
        (isTechnician() && (
          (resource.data.atananTeknisyenId == request.auth.uid || 
           resource.data.atananEkipId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.kategori ||
           (resource.data.atananEkipUyeIds != null && request.auth.uid in resource.data.atananEkipUyeIds)) &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['durum', 'cozumTarihi', 'cozumFotograflari', 'guncellemeTarihi', 'yorumlar', 'kesinlesenRandevu'])
        )) ||
        // Müşteri:
        (resource.data.olusturanId == request.auth.uid && (
          // 1. Düzenleme: Sadece durum 'yeni' ise başlık, açıklama ve fotoğraf değiştirebilir.
          (resource.data.durum == 'yeni' && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['baslik', 'aciklama', 'fotograflar', 'guncellemeTarihi'])) ||
          // 2. İptal: Sadece durum 'yeni' ise iptal edebilir.
          (resource.data.durum == 'yeni' && request.resource.data.durum == 'iptal' && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['durum', 'guncellemeTarihi'])) ||
          // 3. Puanlama: Sadece durum 'cozuldu' ise puan verebilir.
          (resource.data.durum == 'cozuldu' && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['puan', 'degerlendirme', 'degerlendirmeTarihi'])) ||
          // 4. Sohbet: Müşteri yorum ekleyebilir (kapatılmadığı sürece)
          (resource.data.durum != 'kapatildi' && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['yorumlar', 'guncellemeTarihi']))
        ))
      );

      // Silme: Sadece yöneticiler talep silebilir (Cascading delete için gerekli).
      allow delete: if isManager();
    }

    // =====================
    // EKİPLER (ekipler)
    // =====================
    match /ekipler/{ekipId} {
      allow read: if isSignedIn() && (isAdmin() || isTechnician());
      allow create: if isAdmin() || isAdminEmail();
      allow update: if isAdmin() || isAdminEmail();
      allow delete: if isAdmin() || isAdminEmail();
    }

    // =====================
    // PROJELER (projeler)
    // =====================
    match /projeler/{projeId} {
      allow read: if isSignedIn();
      allow write: if isAdmin() || isAdminEmail();
    }

    // =====================
    // PUSH TOKENLARI (push_tokens)
    // SEC-001 FIX: Owner-only access - prevents token exfiltration
    // Cloud Functions will read tokens server-side with admin SDK
    // =====================
    match /push_tokens/{userId} {
      // READ: Sadece token sahibi okuyabilir (admin/teknisyen KALDIRILDI)
      // Cloud Functions admin SDK ile server-side okuyacak
      allow read: if isSignedIn() && isOwner(userId);
      
      // WRITE: Sadece token sahibi yazabilir
      allow write: if isSignedIn() && isOwner(userId);
    }

    // =====================
    // SEC-010: AUDIT LOGS (audit_logs)
    // =====================
    match /audit_logs/{logId} {
      // Okuma: Sadece yöneticiler audit loglarını görebilir
      allow read: if isAdmin();
      
      // Oluşturma: Giriş yapmış herkes kendi adına log oluşturabilir
      // LOG-001: performedBy auth.uid ile eşleşmek zorunda
      allow create: if isSignedIn() && request.resource.data.performedBy == request.auth.uid;
      
      // Güncelleme/Silme: YASAK - Loglar değiştirilemez (immutable)
      allow update, delete: if false;
    }
  }
}

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Yardımcı Fonksiyonlar
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdminEmail() {
      // Sunucu taraflı Admin Beyaz Listesi (Source of Truth)
      return request.auth.token.email in ['admin@dnadestek.com', 'eren.gulmez@dnadestek.com'];
    }

    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rol == 'yonetim';
    }
    
    function isTechnician() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rol == 'teknisyen';
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Kullanıcılar Koleksiyonu
    match /users/{userId} {
      // Oku: Kişi kendi profilini, Admin/Teknisyen ise ilgili profilleri görebilir.
      allow get: if isSignedIn() && (isOwner(userId) || isAdmin() || isTechnician());
      
      // Listele: Sadece yöneticiler tüm kullanıcıları listeleyebilir (Gizlilik Gereği).
      allow list: if isAdmin();
      
      // Oluştur: 
      // - Standart kullanıcılar sadece 'musteri' rolüyle kaydolabilir.
      // - Beyaz listedeki e-postalar 'yonetim' olarak kaydolabilir.
      allow create: if isSignedIn() && isOwner(userId) && (
        request.resource.data.rol == 'musteri' || 
        (request.resource.data.rol == 'yonetim' && isAdminEmail())
      );
      
      // Güncelle: Admin her şeyi yapabilir. Kullanıcı sadece kendi bilgilerini güncelleyebilir (Rol/Aktiflik hariç).
      allow update: if isAdmin() || (isOwner(userId) && (
        request.resource.data.rol == resource.data.rol && 
        request.resource.data.aktif == resource.data.aktif
      ));
      
      // Yönetim paneli üzerinden kullanıcı oluşturma
      allow create: if isAdmin();
    }

    // Talepler Koleksiyonu
    match /talepler/{talepId} {
      // Okuma Kısıtı: Yönetici her şeyi, Teknisyen sadece atanmış işleri görür. Müşteri kendi işini görür.
      allow read: if isSignedIn() && (
        isAdmin() || 
        (isTechnician() && (
          resource.data.atananTeknisyenId == request.auth.uid || 
          resource.data.atananEkipId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.kategori
        )) ||
        resource.data.olusturanId == request.auth.uid ||
        resource.data.musteriId == request.auth.uid
      );

      // Oluşturma: Sadece yeni durumda ve normal/acil öncelikle başlanabilir.
      allow create: if isSignedIn() && 
        request.resource.data.olusturanId == request.auth.uid && 
        request.resource.data.durum == 'yeni' &&
        request.resource.data.oncelik in ['normal', 'acil'];

      // Güncelleme:
      allow update: if isSignedIn() && (
        isAdmin() || 
        // Teknisyen: Sadece atanmış işlerin durumunu, çözümünü ve yorumlarını güncelleyebilir.
        (isTechnician() && (
          (resource.data.atananTeknisyenId == request.auth.uid || 
           resource.data.atananEkipId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.kategori) &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['durum', 'cozumTarihi', 'cozumFotograflari', 'guncellemeTarihi', 'yorumlar'])
        )) ||
        // Müşteri:
        (resource.data.olusturanId == request.auth.uid && (
          // 1. Düzenleme: Sadece durum 'yeni' ise başlık, açıklama ve fotoğraf değiştirebilir.
          (resource.data.durum == 'yeni' && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['baslik', 'aciklama', 'fotograflar', 'guncellemeTarihi'])) ||
          // 2. İptal: Sadece durum 'yeni' ise iptal edebilir.
          (resource.data.durum == 'yeni' && request.resource.data.durum == 'iptal' && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['durum', 'guncellemeTarihi'])) ||
          // 3. Puanlama: Sadece durum 'cozuldu' ise puan verebilir.
          (resource.data.durum == 'cozuldu' && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['puan', 'degerlendirme', 'degerlendirmeTarihi']))
        ))
      );
    }

    // Ekipler Koleksiyonu
    match /ekipler/{ekipId} {
      allow read: if isSignedIn() && (isAdmin() || isTechnician());
      allow write: if isAdmin() || isAdminEmail();
    }

    // Projeler Koleksiyonu
    match /projeler/{projeId} {
      allow read: if isSignedIn();
      allow write: if isAdmin() || isAdminEmail();
    }

    // Push Bildirim Tokenları
    match /push_tokens/{userId} {
      allow read: if isAdmin() || isTechnician();
      allow get, write: if isSignedIn() && isOwner(userId);
    }
  }
}

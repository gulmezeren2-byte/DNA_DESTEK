rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Yardımcı Fonksiyonlar
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdminEmail() {
      // Sunucu taraflı Admin Beyaz Listesi (Source of Truth)
      return request.auth.token.email in ['admin@dnadestek.com', 'eren.gulmez@dnadestek.com'];
    }

    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rol == 'yonetim';
    }
    
    function isTechnician() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rol == 'teknisyen';
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // =====================
    // KULLANICILAR (users)
    // =====================
    match /users/{userId} {
      // Okuma: Kendi profilini herkes, Admin/Teknisyen belirli profilleri görebilir.
      allow get: if isSignedIn() && (isOwner(userId) || isAdmin() || isTechnician());
      
      // Listeleme: Sadece yöneticiler (gizlilik gereği teknisyenler listeleyemez).
      allow list: if isAdmin();
      
      // Oluşturma (TEK KURAL - Konsolide):
      // - Admin herhangi bir kullanıcı oluşturabilir (Yönetim paneli).
      // - Kullanıcı kendi profilini oluşturabilir: sadece 'musteri' veya whitelist'teyse 'yonetim'.
      allow create: if isAdmin() || (
        isSignedIn() && isOwner(userId) && (
          request.resource.data.rol == 'musteri' || 
          (request.resource.data.rol == 'yonetim' && isAdminEmail())
        )
      );
      
      // Güncelleme: Admin herkesin bilgisini güncelleyebilir. 
      // Kullanıcı kendi bilgilerini güncelleyebilir (rol/aktiflik değiştiremez).
      allow update: if isAdmin() || (isOwner(userId) && (
        request.resource.data.rol == resource.data.rol && 
        request.resource.data.aktif == resource.data.aktif
      ));
    }

    // =====================
    // TALEPLER (talepler)
    // =====================
    match /talepler/{talepId} {
      // Okuma: Yönetici her şeyi, Teknisyen sadece atanmış işleri, Müşteri kendi işini görür.
      allow read: if isSignedIn() && (
        isAdmin() || 
        (isTechnician() && (
          resource.data.atananTeknisyenId == request.auth.uid || 
          resource.data.atananEkipId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.kategori
        )) ||
        resource.data.olusturanId == request.auth.uid ||
        resource.data.musteriId == request.auth.uid
      );

      // Oluşturma: Sadece yeni durumda ve normal/acil öncelikle başlanabilir.
      allow create: if isSignedIn() && 
        request.resource.data.olusturanId == request.auth.uid && 
        request.resource.data.durum == 'yeni' &&
        request.resource.data.oncelik in ['normal', 'acil'];

      // Güncelleme:
      allow update: if isSignedIn() && (
        isAdmin() || 
        // Teknisyen: Sadece atanmış işlerin durumunu, çözümünü ve yorumlarını güncelleyebilir.
        (isTechnician() && (
          (resource.data.atananTeknisyenId == request.auth.uid || 
           resource.data.atananEkipId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.kategori) &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['durum', 'cozumTarihi', 'cozumFotograflari', 'guncellemeTarihi', 'yorumlar'])
        )) ||
        // Müşteri:
        (resource.data.olusturanId == request.auth.uid && (
          // 1. Düzenleme: Sadece durum 'yeni' ise başlık, açıklama ve fotoğraf değiştirebilir.
          (resource.data.durum == 'yeni' && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['baslik', 'aciklama', 'fotograflar', 'guncellemeTarihi'])) ||
          // 2. İptal: Sadece durum 'yeni' ise iptal edebilir.
          (resource.data.durum == 'yeni' && request.resource.data.durum == 'iptal' && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['durum', 'guncellemeTarihi'])) ||
          // 3. Puanlama: Sadece durum 'cozuldu' ise puan verebilir.
          (resource.data.durum == 'cozuldu' && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['puan', 'degerlendirme', 'degerlendirmeTarihi']))
        ))
      );
    }

    // =====================
    // EKİPLER (ekipler)
    // =====================
    match /ekipler/{ekipId} {
      allow read: if isSignedIn() && (isAdmin() || isTechnician());
      allow create: if isAdmin() || isAdminEmail();
      allow update: if isAdmin() || isAdminEmail();
      allow delete: if isAdmin() || isAdminEmail();
    }

    // =====================
    // PROJELER (projeler)
    // =====================
    match /projeler/{projeId} {
      allow read: if isSignedIn();
      allow write: if isAdmin() || isAdminEmail();
    }

    // =====================
    // PUSH TOKENLARI (push_tokens)
    // =====================
    match /push_tokens/{userId} {
      allow read: if isAdmin() || isTechnician();
      allow get, write: if isSignedIn() && isOwner(userId);
    }
  }
}
